At any time during the motion we may consider perturbing the system by a virtual displacement δr consistent with the constraints of the system. The displacement is allowed to be either reversible or irreversible. If the displacement is irreversible, then it performs virtual work. We may write the virtual work of the displacement as





W

c


(
t
)
=


C



T



(
q
,



q
˙



,
t
)
δ

r

(
t
)


{\displaystyle W_{c}(t)=\mathbf {C} ^{\mathrm {T} }(q,{\dot {q}},t)\delta \mathbf {r} (t)}

The vector




C

(
q
,



q
˙



,
t
)


{\displaystyle \mathbf {C} (q,{\dot {q}},t)}
describes the non-ideality of the virtual work and may be related, for example, to friction or drag forces (such forces have velocity dependence). This is a generalized D'Alembert's principle, where the usual form of the principle has vanishing virtual work with




C

(
q
,



q
˙



,
t
)
=
0


{\displaystyle \mathbf {C} (q,{\dot {q}},t)=0}
.
The Udwadia–Kalaba equation is modified by an additional non-ideal constraint term to





M





q

¨



=

Q

+


M


1

/

2




(


A



M


−
1

/

2



)


+


(

b

−

A



M


−
1



Q

)
+


M


1

/

2



[


I

−


(


A



M


−
1

/

2



)


+



A



M


−
1

/

2



]



M


1

/

2



C



{\displaystyle \mathbf {M} {\ddot {\mathbf {q} }}=\mathbf {Q} +\mathbf {M} ^{1/2}\left(\mathbf {A} \mathbf {M} ^{-1/2}\right)^{+}(\mathbf {b} -\mathbf {A} \mathbf {M} ^{-1}\mathbf {Q} )+\mathbf {M} ^{1/2}\left[\mathbf {I} -\left(\mathbf {A} \mathbf {M} ^{-1/2}\right)^{+}\mathbf {A} \mathbf {M} ^{-1/2}\right]\mathbf {M} ^{1/2}\mathbf {C} }